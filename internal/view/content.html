<!DOCTYPE html>
<html lang="en">

<head>
  <base href="$$.RootPath$$">
  <title>$$.Book.Title$$ - Shiori - Bookmarks Manager</title>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--
    manifest.webmanifest provides metadata used when your web app is installed on a
    user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
  -->
  <link rel="manifest" type="application/json" href="/manifest.webmanifest">
  <meta name="theme-color" content="#292929"/>
  <meta
  name="description"
  content="Shiori is a simple bookmarks manager written in the Go language. Intended as a simple clone of Pocket."
  >

  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="res/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="res/apple-touch-icon-144x144.png">
  <link rel="icon" type="image/png" href="res/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="res/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/x-icon" href="res/favicon.ico">

  <link href="css/source-sans-pro.min.css" rel="stylesheet">
  <link href="css/stylesheet.css" rel="stylesheet">
  <link href="css/custom-dialog.css" rel="stylesheet">
  <link href="css/bookmark-item.css" rel="stylesheet">

  <script src="js/dayjs.min.js"></script>
  <script src="js/vue.min.js"></script>
</head>

<body class="night">
  <div id="content-scene" :class="{night: appOptions.nightMode}">
    <div id="header">
      <p id="metadata" v-cloak>Added {{localtime()}}</p>
      <p id="title" dir="auto">$$.Book.Title$$</p>
      <div id="links">
        <a href="$$.Book.URL$$" target="_blank" rel="noopener">View Original</a>
        $$if .Book.HasArchive$$
        <a href="bookmark/$$.Book.ID$$/archive">View Archive</a>
        $$end$$
        $$if .Book.HasEbook$$
        <a href="bookmark/$$.Book.ID$$/ebook" download="$$.Book.Title$$.epub">Download Ebook</a>
        $$end$$
      </div>
    </div>
    <div id="content" dir="auto" v-pre>
      $$html .Book.HTML$$
    </div>
  </div>

	<script type="module">
		// Create initial variable
		import basePage from "./assets/js/page/base.js";

    new Vue({
      el: '#content-scene',
      mixins: [basePage],
      data: {
        modified: "$$.Book.Modified$$"
      },
      methods: {
        localtime() {
          var strTime = this.modified.replace(" ", "T");
          if (!strTime.endsWith("Z")) {
            strTime += "Z";
          }
          return dayjs(strTime).format("D MMMM YYYY, HH:mm:ss");
        },
        loadSetting() {
          var opts = JSON.parse(localStorage.getItem("shiori-setting")) || {},
            showId = (typeof opts.showId === "boolean") ? opts.showId : false,
            listMode = (typeof opts.listMode === "boolean") ? opts.listMode : false,
            nightMode = (typeof opts.nightMode === "boolean") ? opts.nightMode : false,
            useArchive = (typeof opts.useArchive === "boolean") ? opts.useArchive : false;

          this.appOptions = {
            showId: showId,
            listMode: listMode,
            nightMode: nightMode,
            useArchive: useArchive,
          };

          document.body.className = nightMode ? "night" : "";
        }
      },
      mounted() {
        this.loadSetting();

        document.querySelectorAll("#content a").forEach(elem => {
          elem.setAttribute("target", "_blank");
          elem.setAttribute("rel", "noopener");
        });
      }
    });
  </script>
  <!-- Register the service worker -->
  <script type="module">
    window.addEventListener('load', () => {
      // Is service worker available?
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(() => {
          console.log('Service worker registered!');
        }).catch((error) => {
          console.warn('Error registering service worker:');
          console.warn(error);
        });
      }
    });
  </script>
    <!-- Register the service worker and background sync -->
  <script type="module">
    window.addEventListener('load', () => {
      // Is service worker available?
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(() => {
          console.log('Service worker registered!');
        }).catch((error) => {
          console.warn('Error registering service worker:');
          console.warn(error);
        });
      }
      // Is background sync available?
      if ('serviceWorker' in navigator && 'SyncManager' in window) {
        navigator.serviceWorker.ready.then((registration) => {
          // Register a periodic background sync
          registration.periodicSync.register('sync-bookmarks', {
            minInterval: 60 * 60 * 1000, // 1 hour
          }).then(() => {
            console.log('Periodic background sync registered!');
          }).catch((error) => {
            console.warn('Error registering periodic background sync:');
            console.warn(error);
          });
        });
      }
    });
  </script>
</body>

</html>
